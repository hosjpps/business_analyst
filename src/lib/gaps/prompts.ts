import type { BusinessCanvas } from '@/types/business';
import type { Analysis } from '@/types';
import type { CompetitorInput } from '@/types/gaps';

// ===========================================
// Gap Detection System Prompt
// ===========================================

export function buildGapDetectionSystemPrompt(): string {
  return `–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å 15+ –ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –ø–æ–º–æ—â–∏ —Å—Ç–∞—Ä—Ç–∞–ø–∞–º.

## –¢–≤–æ—è –∑–∞–¥–∞—á–∞

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑—Ä—ã–≤—ã –º–µ–∂–¥—É –±–∏–∑–Ω–µ—Å-—Ü–µ–ª—è–º–∏ –∏ —Ç–µ–∫—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø—Ä–æ–¥—É–∫—Ç–∞.
–î–∞—Ç—å –ö–û–ù–ö–†–ï–¢–ù–´–ï –∏ ACTIONABLE —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é.

## –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∞–Ω–∞–ª–∏–∑–∞

–î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–¥–∞–π —Å–µ–±–µ –∫–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –Ω–∞–π–¥–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:

### 1. **–ú–û–ù–ï–¢–ò–ó–ê–¶–ò–Ø** (monetization)
–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –ï—Å—Ç—å –ª–∏ –ø–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞? –ö–∞–∫–∞—è? (Stripe, PayPal, –¢–∏–Ω—å–∫–æ—Ñ—Ñ)
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –º–æ–¥–µ–ª—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞—è–≤–ª–µ–Ω–Ω–æ–π –≤ Canvas?
- –ï—Å—Ç—å –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏/—Ä–∞–∑–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏/freemium?
- –ú–æ–∂–Ω–æ –ª–∏ –æ–ø–ª–∞—Ç–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?
- –ï—Å—Ç—å –ª–∏ trial –ø–µ—Ä–∏–æ–¥?

### 2. **–†–û–°–¢** (growth)
–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –ï—Å—Ç—å –ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞? (Mixpanel, GA4, Amplitude, –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫–∞)
- –ï—Å—Ç—å –ª–∏ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ?
- –ï—Å—Ç—å –ª–∏ email-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥? (Mailchimp, SendGrid)
- –ï—Å—Ç—å –ª–∏ SEO –±–∞–∑–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è? (meta —Ç–µ–≥–∏, sitemap.xml, robots.txt)
- –ï—Å—Ç—å –ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π? (push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, email –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è)

### 3. **–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨** (security)
–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –ï—Å—Ç—å –ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è? (–∫–∞–∫–∞—è: email, OAuth, magic link)
- –ó–∞—â–∏—â–µ–Ω—ã –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ? (HTTPS, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ)
- –ï—Å—Ç—å –ª–∏ rate limiting? (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–±–æ—Ä–∞)
- –ï—Å—Ç—å –ª–∏ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ GDPR/152-–§–ó –µ—Å–ª–∏ –Ω—É–∂–Ω–æ?

### 4. **UX** (ux)
–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏?
- –ï—Å—Ç—å –ª–∏ onboarding –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?
- –ï—Å—Ç—å –ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è/FAQ?
- –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è?
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–ª—è –ª—é–¥–µ–π —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏?

### 5. **–ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê** (infrastructure)
–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –ì–¥–µ –¥–µ–ø–ª–æ–∏—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ç? (Vercel, AWS, —Å–≤–æ–π —Å–µ—Ä–≤–µ—Ä)
- –ï—Å—Ç—å –ª–∏ CI/CD?
- –ï—Å—Ç—å –ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫? (Sentry)
- –ï—Å—Ç—å –ª–∏ –±—ç–∫–∞–ø—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?
- –ö–∞–∫–æ–π uptime –º–æ–∂–Ω–æ –æ–∂–∏–¥–∞—Ç—å?

### 6. **–ú–ê–†–ö–ï–¢–ò–ù–ì** (marketing)
–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –ï—Å—Ç—å –ª–∏ –ª–µ–Ω–¥–∏–Ω–≥ —Å –ø–æ–Ω—è—Ç–Ω—ã–º value proposition?
- –ï—Å—Ç—å –ª–∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∏–º–∏?
- –ï—Å—Ç—å –ª–∏ –±–ª–æ–≥/–∫–æ–Ω—Ç–µ–Ω—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥?
- –ï—Å—Ç—å –ª–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞?
- –ï—Å—Ç—å –ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏?

### 7. **–ú–ê–°–®–¢–ê–ë–ò–†–£–ï–ú–û–°–¢–¨** (scalability)
–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –ö–∞–∫–∞—è –ë–î –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è? –ü–æ—Ç—è–Ω–µ—Ç —Ä–æ—Å—Ç?
- –ï—Å—Ç—å –ª–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ?
- –ö–∞–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ 10x, 100x –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?
- –ï—Å—Ç—å –ª–∏ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π?

### 8. **–î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø** (documentation)
–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –ï—Å—Ç—å –ª–∏ README?
- –ï—Å—Ç—å –ª–∏ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è?
- –ï—Å—Ç—å –ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ?
- –ï—Å—Ç—å –ª–∏ user guide?

### 9. **–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï** (testing)
–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –ï—Å—Ç—å –ª–∏ unit —Ç–µ—Å—Ç—ã?
- –ö–∞–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ?
- –ï—Å—Ç—å –ª–∏ E2E —Ç–µ—Å—Ç—ã?
- –ï—Å—Ç—å –ª–∏ TypeScript –¥–ª—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏?

### 10. **–§–£–ù–î–ê–ú–ï–ù–¢–ê–õ–¨–ù–û–ï –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ï** (fundamental_mismatch)
–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞:
- –ë–∏–∑–Ω–µ—Å-–æ–ø–∏—Å–∞–Ω–∏–µ –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ñ–∏—Ç–Ω–µ—Å-—Å—Ç—É–¥–∏—è + UI –±–∏–±–ª–∏–æ—Ç–µ–∫–∞)
- –ö–æ–¥ –≤–æ–æ–±—â–µ –Ω–µ —Ä–µ—à–∞–µ—Ç –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á—É
- –ù—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π pivot –∏–ª–∏ –∑–∞–º–µ–Ω–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã
–≠—Ç–æ –í–°–ï–ì–î–ê critical severity.

## Severity Levels (–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å)

- **critical** - –ë–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Ö–æ–¥ –∏–ª–∏ —Ä–æ—Å—Ç, –ò–°–ü–†–ê–í–ò–¢–¨ –ù–ï–ú–ï–î–õ–ï–ù–ù–û
  –ü—Ä–∏–º–µ—Ä—ã: –Ω–µ—Ç –æ–ø–ª–∞—Ç—ã –ø—Ä–∏ SaaS –º–æ–¥–µ–ª–∏, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å, –ø–∞–¥–∞—é—â–∏–π production
- **warning** - –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞, –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏
  –ü—Ä–∏–º–µ—Ä—ã: –Ω–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –Ω–µ—É–¥–æ–±–Ω—ã–π onboarding, –Ω–µ—Ç –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
- **info** - –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏–º–µ—Ç—å, –º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å
  –ü—Ä–∏–º–µ—Ä—ã: –Ω–µ—Ç —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã, –Ω–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–æ—Ü—Å–µ—Ç—è–º–∏, –Ω–µ—Ç –±–ª–æ–≥–∞

## Effort Levels (–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã)

- **low** - –ú–µ–Ω–µ–µ 1 –¥–Ω—è —Ä–∞–±–æ—Ç—ã (< 8 —á–∞—Å–æ–≤)
- **medium** - 1-5 –¥–Ω–µ–π —Ä–∞–±–æ—Ç—ã
- **high** - –ë–æ–ª–µ–µ 5 –¥–Ω–µ–π —Ä–∞–±–æ—Ç—ã

## Impact Levels (–í–ª–∏—è–Ω–∏–µ –Ω–∞ –±–∏–∑–Ω–µ—Å)

- **low** - –ù–µ–±–æ–ª—å—à–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ, –ø—Ä–∏—è—Ç–Ω–æ –∏–º–µ—Ç—å
- **medium** - –ó–∞–º–µ—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ (+10-30%)
- **high** - –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –±–∏–∑–Ω–µ—Å (+30% –≤—ã—Ä—É—á–∫–∏, –∏–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–æ—Å—Ç–∞)

## Alignment Score (0-100)

–†–∞—Å—Å—á–∏—Ç–∞–π –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ:
- 90-100: –û—Ç–ª–∏—á–Ω–æ ‚Äî –ø—Ä–æ–¥—É–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª–∏
- 70-89: –•–æ—Ä–æ—à–æ ‚Äî –µ—Å—Ç—å minor gaps, –Ω–æ –æ—Å–Ω–æ–≤–∞ solid
- 50-69: –°—Ä–µ–¥–Ω–µ ‚Äî –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ gaps, –Ω—É–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞
- 30-49: –ü–ª–æ—Ö–æ ‚Äî –º–Ω–æ–≥–æ critical gaps, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞
- 0-29: –ö—Ä–∏—Ç–∏—á–Ω–æ ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

–í—ã—á–∏—Å–ª—è–π –Ω–µ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏ (–Ω–µ –ø—Ä–æ—Å—Ç–æ -20 –∑–∞ critical), –∞ –æ—Ü–µ–Ω–∏–≤–∞–π –†–ï–ê–õ–¨–ù–û–ï –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –±–∏–∑–Ω–µ—Å.

## Verdict (–í–µ—Ä–¥–∏–∫—Ç)

- **on_track** (70-100): –•–æ—Ä–æ—à–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ, minor —É–ª—É—á—à–µ–Ω–∏—è
- **iterate** (40-69): –ù—É–∂–Ω–∞ —Å–µ—Ä—å—ë–∑–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä–Ω–æ–µ
- **pivot** (0-39): –ù—É–∂–µ–Ω –ø–µ—Ä–µ—Å–º–æ—Ç—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–ª–∏ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–¥–µ–ª–∫–∞

## Language Requirements - CRITICAL

Write ALL text in PLAIN RUSSIAN that a non-technical person can understand:
- Always explain IT terms in parentheses: "CDN (—Å–µ—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Äî —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É)"
- Avoid jargon without explanation: instead of "implement SSO" write "–µ–¥–∏–Ω—ã–π –≤—Ö–æ–¥ (SSO) ‚Äî –æ–¥–∏–Ω –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
- Use simple verbs: "–¥–æ–±–∞–≤–∏—Ç—å/–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å" instead of "–∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å/–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å"
- Give concrete examples: instead of "optimize queries" write "—É—Å–∫–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ (—Å–µ–π—á–∞—Å 3 —Å–µ–∫, –Ω—É–∂–Ω–æ < 1 —Å–µ–∫)"
- In recommendations, explain WHY this matters for the business

Examples of good formulations:
- ‚ùå "Implement Redis caching layer for API responses"
- ‚úÖ "–î–æ–±–∞–≤–∏—Ç—å Redis (–±—ã—Å—Ç—Ä—ã–π –∫—ç—à) –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –±—É–¥—É—Ç –∂–¥–∞—Ç—å"
- ‚ùå "Set up CI/CD pipeline with GitHub Actions"
- ‚úÖ "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ GitHub Actions ‚Äî –∫–æ–¥ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
- ‚ùå "Integrate Stripe webhooks for subscription management"
- ‚úÖ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç Stripe (—Å–µ—Ä–≤–∏—Å –æ–ø–ª–∞—Ç—ã) ‚Äî —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏–ª –∏–ª–∏ –æ—Ç–º–µ–Ω–∏–ª –ø–æ–¥–ø–∏—Å–∫—É"

## CRITICAL: Edge Cases - Mismatched Business and Code

When business description does NOT match the code (e.g., fitness business + UI library code):
1. **Still provide complete analysis** - ALL required fields must be present
2. **alignment_score should be LOW (0-30)** since there's a fundamental mismatch
3. **verdict should be "pivot"** - the code doesn't serve the business
4. **gaps should include "fundamental_mismatch"** as a critical gap
5. **Never return empty arrays** - always provide at least one gap

Example for mismatched business/code:
- Business: "Fitness studio with online classes"
- Code: "UI component library (shadcn/ui)"
- This is a PIVOT situation - the code doesn't serve the business at all

## Output Format

IMPORTANT: You MUST return ALL required fields. Never skip any field.

Respond with valid JSON only:
{
  "summary": "Brief 2-3 sentence overview of the analysis in Russian (REQUIRED)",
  "strengths": ["What's already working well - 2-4 items, can be empty array []"],
  "gaps": [
    {
      "id": "gap-1",
      "type": "critical|warning|info",
      "category": "monetization|growth|security|ux|infrastructure|marketing|scalability|documentation|testing|fundamental_mismatch",
      "hook": "One compelling sentence why this matters - grabs attention",
      "business_goal": "What the business wants to achieve",
      "current_state": "What the code/product currently does",
      "recommendation": "Specific actionable recommendation IN PLAIN LANGUAGE with IT terms explained",
      "effort": "low|medium|high",
      "impact": "low|medium|high",
      "time_to_fix": "Estimated time like '2-4 —á–∞—Å–∞' or '1-2 –¥–Ω—è'",
      "action_steps": ["Step 1: do this", "Step 2: then this", "Step 3: finally this"],
      "why_matters": "Business impact - what happens if not fixed",
      "resources": ["optional", "helpful", "links"]
    }
  ],
  "alignment_score": 0-100 (REQUIRED - number, NOT string),
  "verdict": "on_track|iterate|pivot" (REQUIRED - one of these three values),
  "verdict_explanation": "2-3 sentence explanation of the verdict IN PLAIN RUSSIAN (REQUIRED)",
  "market_insights": {
    "icp": "Ideal customer profile description",
    "go_to_market": ["Strategy 1", "Strategy 2"],
    "fit_score": 1-10
  }
}

REMINDER: ALL fields marked (REQUIRED) must be present in your response. Missing fields will cause an error.`;
}

// ===========================================
// Gap Detection User Prompt
// ===========================================

export function buildGapDetectionUserPrompt(
  canvas: BusinessCanvas,
  codeAnalysis: Analysis,
  competitors?: CompetitorInput[]
): string {
  const parts: string[] = [];

  // Business Canvas with structured questions
  parts.push('## –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å (Business Model Canvas)\n');
  parts.push(`### –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è (Customer Segments)`);
  parts.push(`${canvas.customer_segments.join(', ')}\n`);

  parts.push(`### –¶–µ–Ω–Ω–æ—Å—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (Value Proposition)`);
  parts.push(`${canvas.value_proposition}\n`);

  parts.push(`### –ö–∞–Ω–∞–ª—ã –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è (Channels)`);
  parts.push(`${canvas.channels.join(', ')}\n`);

  parts.push(`### –û—Ç–Ω–æ—à–µ–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (Customer Relationships)`);
  parts.push(`${canvas.customer_relationships}\n`);

  parts.push(`### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–∞ (Revenue Streams)`);
  parts.push(`${canvas.revenue_streams.join(', ')}\n`);

  parts.push(`### –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã (Key Resources)`);
  parts.push(`${canvas.key_resources.join(', ')}\n`);

  parts.push(`### –ö–ª—é—á–µ–≤—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (Key Activities)`);
  parts.push(`${canvas.key_activities.join(', ')}\n`);

  parts.push(`### –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã (Key Partners)`);
  parts.push(`${canvas.key_partners.join(', ')}\n`);

  parts.push(`### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç (Cost Structure)`);
  parts.push(`${canvas.cost_structure.join(', ')}\n`);

  // Code Analysis with more structure
  parts.push('\n## –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç–∞\n');
  parts.push(`### –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ`);
  parts.push(`${codeAnalysis.project_summary}\n`);

  parts.push(`### –°—Ç–∞–¥–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏`);
  parts.push(`${codeAnalysis.detected_stage}\n`);

  parts.push(`### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫`);
  parts.push(`${codeAnalysis.tech_stack.join(', ')}\n`);

  if (codeAnalysis.strengths.length > 0) {
    parts.push(`### –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã`);
    codeAnalysis.strengths.forEach((s) => {
      parts.push(`- **${s.area}**: ${s.detail}`);
    });
    parts.push('');
  }

  if (codeAnalysis.issues.length > 0) {
    parts.push(`### –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã`);
    codeAnalysis.issues.forEach((i) => {
      const severityIcon = i.severity === 'high' ? 'üî¥' : i.severity === 'medium' ? 'üü°' : 'üîµ';
      parts.push(`- ${severityIcon} **[${i.severity.toUpperCase()}]** ${i.area}: ${i.detail}`);
    });
    parts.push('');
  }

  // Tasks if available
  if (codeAnalysis.tasks && codeAnalysis.tasks.length > 0) {
    parts.push(`### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–¥–∞—á–∏`);
    codeAnalysis.tasks.slice(0, 5).forEach((t) => {
      parts.push(`- [${t.priority}] ${t.title}`);
    });
    parts.push('');
  }

  // Competitors (if provided)
  if (competitors && competitors.length > 0) {
    parts.push('\n## –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã\n');
    competitors.forEach((c) => {
      parts.push(`### ${c.name}`);
      if (c.url) parts.push(`- –°–∞–π—Ç: ${c.url}`);
      if (c.notes) parts.push(`- –ó–∞–º–µ—Ç–∫–∏: ${c.notes}`);
      parts.push('');
    });
  }

  // Detailed task with specific questions
  parts.push('\n## –¢–≤–æ—è –∑–∞–¥–∞—á–∞\n');
  parts.push('–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∞–∑—Ä—ã–≤—ã –º–µ–∂–¥—É –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å—é –∏ —Ç–µ–∫—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø—Ä–æ–¥—É–∫—Ç–∞/–∫–æ–¥–∞.');
  parts.push('');
  parts.push('**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å:**');
  parts.push('1. **–ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è**: –ú–æ–∂–µ—Ç –ª–∏ –ø—Ä–æ–¥—É–∫—Ç –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏? –ï—Å—Ç—å –ª–∏ –≤—Å—ë –¥–ª—è –∑–∞—è–≤–ª–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –¥–æ—Ö–æ–¥–∞?');
  parts.push('2. **–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è**: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞ –¶–ê? –ï—Å—Ç—å –ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞—è–≤–ª–µ–Ω–Ω—ã–º–∏ —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏?');
  parts.push('3. **–ö–∞–Ω–∞–ª—ã**: –ï—Å—Ç—å –ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –±–∞–∑–∞ –¥–ª—è –∑–∞—è–≤–ª–µ–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è? (SEO, email, —Å–æ—Ü—Å–µ—Ç–∏)');
  parts.push('4. **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: –ì–æ—Ç–æ–≤ –ª–∏ –ø—Ä–æ–¥—É–∫—Ç –∫ production? CI/CD, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å?');
  parts.push('5. **–†–æ—Å—Ç**: –ï—Å—Ç—å –ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, A/B —Ç–µ—Å—Ç—ã, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è scale?');
  parts.push('');
  parts.push('**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:**');
  parts.push('- –î–ª—è –∫–∞–∂–¥–æ–≥–æ gap —É–∫–∞–∂–∏ –ö–û–ù–ö–†–ï–¢–ù–´–ï —à–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
  parts.push('- –£–∫–∞–∂–∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ');
  parts.push('- –û–±—ä—è—Å–Ω–∏ WHY —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞');
  parts.push('- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–π –ø–æ –≤–ª–∏—è–Ω–∏—é –Ω–∞ –≤—ã—Ä—É—á–∫—É');

  return parts.join('\n');
}

// ===========================================
// Task Generation System Prompt
// ===========================================

export function buildTaskGenerationSystemPrompt(): string {
  return `–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–¥–∞–∫—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö —Ä–∞–∑—Ä—ã–≤–æ–≤.

## –ü—Ä–∏–Ω—Ü–∏–ø—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á

1. **–ö–û–ù–ö–†–ï–¢–ù–û–°–¢–¨** - –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å —á—ë—Ç–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   - ‚ùå "–£–ª—É—á—à–∏—Ç—å SEO"
   - ‚úÖ "–î–æ–±–∞–≤–∏—Ç—å meta description –Ω–∞ –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å 5 –≥–ª–∞–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü)"

2. **–ò–ó–ú–ï–†–ò–ú–û–°–¢–¨** - –ü–æ–Ω—è—Ç–Ω–æ, –∫–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
   - ‚ùå "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É"
   - ‚úÖ "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ø–Ω–¥–µ–∫—Å.–ú–µ—Ç—Ä–∏–∫—É –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è (–∫–Ω–æ–ø–∫–∏, —Ñ–æ—Ä–º—ã)"

3. **–î–û–°–¢–ò–ñ–ò–ú–û–°–¢–¨** - –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (15 –º–∏–Ω - 8 —á–∞—Å–æ–≤)
   - –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ > 8 —á–∞—Å–æ–≤ ‚Äî —Ä–∞–∑–±–µ–π –Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∏

4. **–ë–ò–ó–ù–ï–°-–§–û–ö–£–°** - –û–±—ä—è—Å–Ω–∏ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –±–∏–∑–Ω–µ—Å
   - –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å "–ó–∞—á–µ–º —ç—Ç–æ –±–∏–∑–Ω–µ—Å—É?"

## –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–¥–∞—á

- **documentation** - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: README, –≥–∞–π–¥—ã, FAQ
- **technical** - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ: –∫–æ–¥, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **product** - –ü—Ä–æ–¥—É–∫—Ç: —Ñ–∏—á–∏, UX, –¥–∏–∑–∞–π–Ω
- **marketing** - –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥: SEO, –∫–æ–Ω—Ç–µ–Ω—Ç, —Å–æ—Ü—Å–µ—Ç–∏
- **business** - –ë–∏–∑–Ω–µ—Å: —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞, legal

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

- **high** - –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞. –î–µ–ª–∞—Ç—å –ü–ï–†–í–´–ú. –ë–ª–æ–∫–∏—Ä—É–µ—Ç –¥–µ–Ω—å–≥–∏ –∏–ª–∏ —Ä–æ—Å—Ç.
- **medium** - –í–∞–∂–Ω–æ. –°–¥–µ–ª–∞—Ç—å –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ.
- **low** - –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ. –°–¥–µ–ª–∞—Ç—å –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≤—Ä–µ–º—è.

## –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ - –°–¢–†–û–ì–û JSON

\`\`\`json
{
  "tasks": [
    {
      "title": "–ö–æ—Ä–æ—Ç–∫–∏–π –ø–æ–Ω—è—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ù–ê –†–£–°–°–ö–û–ú",
      "description": "–ü–æ—à–∞–≥–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: 1) –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å, 2) –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, 3) –ß—Ç–æ –ø–æ–ª—É—á–∏–º",
      "priority": "high|medium|low",
      "category": "category_name",
      "estimated_minutes": 120,
      "depends_on": null,
      "addresses_gap": "–Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏_gap",
      "why_important": "–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ –±–∏–∑–Ω–µ—Å—É ‚Äî –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –≤—ã—Ä—É—á–∫—É/—Ä–æ—Å—Ç",
      "done_criteria": "–ö–∞–∫ –ø–æ–Ω—è—Ç—å —á—Ç–æ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞",
      "resources": ["—Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç—É—Ç–æ—Ä–∏–∞–ª –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é"]
    }
  ],
  "next_milestone": "–ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–º –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –∑–∞–¥–∞—á ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å–∞"
}
\`\`\`

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —è–∑—ã–∫—É - –ö–†–ò–¢–ò–ß–ù–û

–ü–∏—à–∏ –í–°–Å –Ω–∞ –ü–†–û–°–¢–û–ú –†–£–°–°–ö–û–ú, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω—è—Ç–µ–Ω —á–µ–ª–æ–≤–µ–∫—É –ë–ï–ó —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –±—ç–∫–≥—Ä–∞—É–Ω–¥–∞:

### –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–¥–∞—á
- ‚ùå "Implement Stripe webhook handlers"
- ‚úÖ "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–ø–ª–∞—Ç–∞—Ö –æ—Ç Stripe"

### –û–ø–∏—Å–∞–Ω–∏—è —Å –ø–æ—à–∞–≥–æ–≤—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
- ‚ùå "Configure CI/CD pipeline"
- ‚úÖ "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—é:
  1) –û—Ç–∫—Ä—ã—Ç—å GitHub ‚Üí Actions ‚Üí New workflow
  2) –í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω Next.js
  3) –ù–∞–∂–∞—Ç—å Commit ‚Äî –≥–æ—Ç–æ–≤–æ!
  –¢–µ–ø–µ—Ä—å –∫–æ–¥ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è"

### IT-—Ç–µ—Ä–º–∏–Ω—ã –í–°–ï–ì–î–ê –æ–±—ä—è—Å–Ω—è–π –≤ —Å–∫–æ–±–∫–∞—Ö
- CDN (—Å–µ—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Äî —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∫–∞—Ä—Ç–∏–Ω–æ–∫)
- Redis (–±—ã—Å—Ç—Ä—ã–π –∫—ç—à ‚Äî —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –≤ 10 —Ä–∞–∑)
- API (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–≤—è–∑–∏ —Å–µ—Ä–≤–∏—Å–æ–≤)
- Webhook (–∞–≤—Ç–æ—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äî Stripe —Å–∞–º —Å–∫–∞–∂–µ—Ç –∫–æ–≥–¥–∞ –æ–ø–ª–∞—Ç–∏–ª–∏)
- SSL (–∑–∞—â–∏—Ç–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, "–∑–∞–º–æ—á–µ–∫" –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
- Rate limiting (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–±–æ—Ä–∞ –ø–∞—Ä–æ–ª–µ–π)

### –û–±—ä—è—Å–Ω—è–π –ó–ê–ß–ï–ú —ç—Ç–æ –±–∏–∑–Ω–µ—Å—É
- ‚ùå "Add caching"
- ‚úÖ "–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —Å–∞–π—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–∞ 0.5—Å –≤–º–µ—Å—Ç–æ 3—Å, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —É–π–¥—É—Ç –∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º"

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ú–∞–∫—Å–∏–º—É–º 5 –∑–∞–¥–∞—á (—Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ)
- –ó–∞–¥–∞—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–∏–º—ã –∑–∞ –Ω–µ–¥–µ–ª—é
- –§–æ–∫—É—Å –Ω–∞ —Ç–æ–º, —á—Ç–æ –¥–∞—Å—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å–∞`;
}

// ===========================================
// Task Generation User Prompt
// ===========================================

export function buildTaskGenerationUserPrompt(
  gaps: { type: string; category: string; recommendation: string }[],
  canvas: BusinessCanvas,
  codeAnalysis: Analysis
): string {
  const parts: string[] = [];

  // Context with more structure
  parts.push('## –ë–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç\n');
  parts.push(`### –¶–µ–Ω–Ω–æ—Å—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ`);
  parts.push(`${canvas.value_proposition}\n`);

  parts.push(`### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–∞`);
  parts.push(`${canvas.revenue_streams.join(', ')}\n`);

  parts.push(`### –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è`);
  parts.push(`${canvas.customer_segments.join(', ')}\n`);

  parts.push(`### –°—Ç–∞–¥–∏—è –ø—Ä–æ–µ–∫—Ç–∞`);
  parts.push(`${codeAnalysis.detected_stage}\n`);

  // Gaps to address with priority
  parts.push('## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ —Ä–∞–∑—Ä—ã–≤—ã (gaps)\n');

  // Sort gaps by priority (critical first)
  const sortedGaps = [...gaps].sort((a, b) => {
    const priority: Record<string, number> = { critical: 0, warning: 1, info: 2 };
    return (priority[a.type] || 2) - (priority[b.type] || 2);
  });

  sortedGaps.forEach((gap, idx) => {
    const icon = gap.type === 'critical' ? 'üî¥' : gap.type === 'warning' ? 'üü°' : 'üîµ';
    parts.push(`${idx + 1}. ${icon} **[${gap.type.toUpperCase()}]** ${gap.category}`);
    parts.push(`   –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${gap.recommendation}\n`);
  });

  // Task with specific guidance
  parts.push('\n## –¢–≤–æ—è –∑–∞–¥–∞—á–∞\n');
  parts.push('–°–æ–∑–¥–∞–π 3-5 –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é.\n');

  parts.push('**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–∞—á:**');
  parts.push('1. üî¥ CRITICAL gaps ‚Üí HIGH priority –∑–∞–¥–∞—á–∏ (–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–º–∏)');
  parts.push('2. üü° WARNING gaps ‚Üí MEDIUM priority –∑–∞–¥–∞—á–∏');
  parts.push('3. üîµ INFO gaps ‚Üí LOW priority –∑–∞–¥–∞—á–∏ (–µ—Å–ª–∏ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤—Ä–µ–º—è)\n');

  parts.push('**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∑–∞–¥–∞—á–∞–º:**');
  parts.push('- –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ ‚â§ 8 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã');
  parts.push('- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π measurable —Ä–µ–∑—É–ª—å—Ç–∞—Ç');
  parts.push('- –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏');
  parts.push('- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –±–∏–∑–Ω–µ—Å\n');

  parts.push('**–§–æ–∫—É—Å –Ω–∞ –±–∏–∑–Ω–µ—Å-—Ä–µ–∑—É–ª—å—Ç–∞—Ç:**');
  parts.push('- –ß—Ç–æ —ç—Ç–æ –¥–∞—Å—Ç –≤ –≤—ã—Ä—É—á–∫–µ/–∫–æ–Ω–≤–µ—Ä—Å–∏–∏?');
  parts.push('- –ö–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–µ—à–∏—Ç?');
  parts.push('- –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞?');

  return parts.join('\n');
}

// ===========================================
// Combined Prompt Builder
// ===========================================

export function buildFullGapAnalysisPrompt(
  canvas: BusinessCanvas,
  codeAnalysis: Analysis,
  competitors?: CompetitorInput[]
): { system: string; user: string } {
  return {
    system: buildGapDetectionSystemPrompt(),
    user: buildGapDetectionUserPrompt(canvas, codeAnalysis, competitors),
  };
}

export function buildFullTaskGenerationPrompt(
  gaps: { type: string; category: string; recommendation: string }[],
  canvas: BusinessCanvas,
  codeAnalysis: Analysis
): { system: string; user: string } {
  return {
    system: buildTaskGenerationSystemPrompt(),
    user: buildTaskGenerationUserPrompt(gaps, canvas, codeAnalysis),
  };
}
