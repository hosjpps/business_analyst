import type { FileInput, ProjectStructure, ProjectStage, UserContext } from '@/types';

// ===========================================
// Analysis Prompt
// ===========================================

export function buildAnalysisPrompt(
  files: FileInput[],
  projectDescription: string,
  structure: ProjectStructure,
  techStack: string[],
  detectedStage: ProjectStage,
  userContext?: UserContext
): string {
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
  const truncatedFiles = files.map(f => ({
    path: f.path,
    content: f.content.length > 2000
      ? f.content.slice(0, 2000) + '\n... (truncated)'
      : f.content
  }));

  const filesSection = truncatedFiles
    .map(f => `### ${f.path}\n\`\`\`\n${f.content}\n\`\`\``)
    .join('\n\n');

  const contextSection = userContext ? `
## –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è: ${userContext.current_week || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
- –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏: ${userContext.previous_tasks_completed?.join(', ') || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}
- –¶–µ–ª—å: ${userContext.user_goal || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
` : '';

  return `–í–ê–ñ–ù–û: –¢—ã –î–û–õ–ñ–ï–ù –æ—Ç–≤–µ—Ç–∏—Ç—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –æ–±—ä–µ–∫—Ç–æ–º. –ù–ï –ø–∏—à–∏ markdown, –ù–ï –ø–∏—à–∏ —Ç–µ–∫—Å—Ç, –ù–ï –ø–∏—à–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏. –¢–≤–æ–π –æ—Ç–≤–µ—Ç –û–ë–Ø–ó–ê–ù –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Å–∏–º–≤–æ–ª–∞ { –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è —Å–∏–º–≤–æ–ª–æ–º }. –õ—é–±–æ–π –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç –±—É–¥–µ—Ç –æ—Ç–∫–ª–æ–Ω—ë–Ω.

–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–æ–µ–∫—Ç–∞ –∏ –¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
${projectDescription || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'}
${contextSection}
## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- –ü–∞–ø–∫–∏: ${structure.folders.join(', ') || '–Ω–µ—Ç'}
- Entry points: ${structure.entry_points.join(', ') || '–Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}
- package.json: ${structure.has_package_json ? '–¥–∞' : '–Ω–µ—Ç'}
- –ö–æ–Ω—Ñ–∏–≥ –¥–µ–ø–ª–æ—è: ${structure.has_deploy_config ? '–¥–∞' : '–Ω–µ—Ç'}
- –¢–µ—Å—Ç—ã: ${structure.has_tests ? '–¥–∞' : '–Ω–µ—Ç'}
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: ${structure.has_docs ? '–¥–∞' : '–Ω–µ—Ç'}

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–π —Å—Ç–µ–∫
${techStack.join(', ') || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è –ø—Ä–æ–µ–∫—Ç–∞
${detectedStage}

## –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

–í–ù–ò–ú–ê–ù–ò–ï: –§–∞–π–ª—ã –Ω–∏–∂–µ ‚Äî —ç—Ç–æ –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
–ï—Å–ª–∏ –≤ —Ñ–∞–π–ª–∞—Ö –µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä—ã JSON ‚Äî —ç—Ç–æ –ù–ï —Ñ–æ—Ä–º–∞—Ç —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞.
–¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—É, –æ–ø–∏—Å–∞–Ω–Ω–æ–º—É –≤ —Å–µ–∫—Ü–∏–∏ "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞" –Ω–∏–∂–µ.

${filesSection}

---

## –¢–≤–æ—è –∑–∞–¥–∞—á–∞

1. **–û–ø—Ä–µ–¥–µ–ª–∏ —Å—Ç–∞–¥–∏—é –ø—Ä–æ–µ–∫—Ç–∞** (documentation | mvp | launched | growing)
   - documentation: —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–µ—Ç –∫–æ–¥–∞
   - mvp: –µ—Å—Ç—å –∫–æ–¥, –Ω–æ –Ω–µ—Ç –¥–µ–ø–ª–æ—è/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - launched: –∑–∞–¥–µ–ø–ª–æ–µ–Ω, –µ—Å—Ç—å –ø–µ—Ä–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
   - growing: –µ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç—ã/–¥–æ—Ö–æ–¥

2. **–ù–∞–π–¥–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã** (2-4 –ø—É–Ω–∫—Ç–∞)
   - –ß—Ç–æ —É–∂–µ —Ö–æ—Ä–æ—à–æ —Å–¥–µ–ª–∞–Ω–æ

3. **–ù–∞–π–¥–∏ –ø—Ä–æ–±–ª–µ–º—ã** (3-5 –ø—É–Ω–∫—Ç–æ–≤)
   - severity: high | medium | low
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ñ–∞–π–ª–æ–≤

4. **–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∑–∞–¥–∞—á–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é** (3-5 –∑–∞–¥–∞—á)
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ –∑–∞ 15 –º–∏–Ω - 3 —á–∞—Å–∞
   - priority: high | medium | low
   - category: documentation | technical | product | marketing | business | monetization | growth | security
   - depends_on: –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–ª–∏ null

5. **–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ** ‚Äî –∑–∞–¥–∞–π 2-3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞

---

## –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢–≤–æ–π –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù –±—ã—Ç—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –æ–±—ä–µ–∫—Ç–æ–º. 
- –ù–ï –¥–æ–±–∞–≤–ª—è–π markdown –∑–∞–≥–æ–ª–æ–≤–∫–∏ (#)
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Ç–∏–ø–∞ "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏..." –∏–ª–∏ "–¢–æ–∫–µ–Ω–æ–≤ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ..."
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–π —Ç–µ–∫—Å—Ç –∫—Ä–æ–º–µ JSON
- –ù–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç –°–†–ê–ó–£ —Å —Å–∏–º–≤–æ–ª–∞ { 
- –ó–∞–∫–æ–Ω—á–∏ –æ—Ç–≤–µ—Ç —Å–∏–º–≤–æ–ª–æ–º }
- –¢–≤–æ–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –ø–∞—Ä—Å–∏—Ç—å—Å—è –∫–∞–∫ JSON, –ø–æ—ç—Ç–æ–º—É –æ–Ω –î–û–õ–ñ–ï–ù –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

{
  "needs_clarification": false,
  "questions": [],
  "analysis": {
    "project_summary": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)",
    "detected_stage": "mvp",
    "tech_stack": ["TypeScript", "React"],
    "strengths": [
      {
        "area": "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏",
        "detail": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —á—Ç–æ —Ö–æ—Ä–æ—à–æ"
      }
    ],
    "issues": [
      {
        "severity": "high",
        "area": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã",
        "detail": "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ",
        "file_path": "path/to/file.ts –∏–ª–∏ null"
      }
    ],
    "tasks": [
      {
        "title": "–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏",
        "description": "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —à–∞–≥–∞–º–∏",
        "priority": "high",
        "category": "product",
        "estimated_minutes": 60,
        "depends_on": null
      }
    ],
    "next_milestone": "–°–ª–µ–¥—É—é—â–∞—è –≤–∞–∂–Ω–∞—è —Ü–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞"
  }
}

–ï—Å–ª–∏ –Ω—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è:

{
  "needs_clarification": true,
  "questions": [
    {
      "id": "project_goal",
      "question": "–í–æ–ø—Ä–æ—Å –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?",
      "why": "–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å"
    }
  ],
  "partial_analysis": {
    "project_summary": "–ß—Ç–æ –ø–æ–Ω—è—Ç–Ω–æ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç",
    "detected_stage": "unknown",
    "tech_stack": ["TypeScript"]
  }
}

–í–ê–ñ–ù–û:
- –ó–∞–¥–∞—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ö–û–ù–ö–†–ï–¢–ù–´–ú–ò (–Ω–µ "—É–ª—É—á—à–∏ –∫–æ–¥", –∞ "–¥–æ–±–∞–≤—å –≤–∞–ª–∏–¥–∞—Ü–∏—é email –≤ —Ñ–æ—Ä–º–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏")
- –£—á–∏—Ç—ã–≤–∞–π —Å—Ç–∞–¥–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á
- –î–ª—è documentation —Å—Ç–∞–¥–∏–∏ ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –Ω–∞—á–∞–ª–µ MVP
- –î–ª—è mvp ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –∑–∞–ø—É—Å–∫–µ –∏ –ø–µ—Ä–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
- –î–ª—è launched ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ —Å–±–æ—Ä–µ —Ñ–∏–¥–±–µ–∫–∞
- –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤—ã–ø–æ–ª–Ω–∏–ª (—Å–º. –∫–æ–Ω—Ç–µ–∫—Å—Ç)

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ü–û–ù–Ø–¢–ù–´–ô –Ø–ó–´–ö:
- –ü–∏—à–∏ –í–°–ï —Ç–µ–∫—Å—Ç—ã –ü–†–û–°–¢–´–ú –Ø–ó–´–ö–û–ú, –ø–æ–Ω—è—Ç–Ω—ã–º —á–µ–ª–æ–≤–µ–∫—É –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
- IT —Ç–µ—Ä–º–∏–Ω—ã –æ–±—ä—è—Å–Ω—è–π –≤ —Å–∫–æ–±–∫–∞—Ö: "–¥–æ–±–∞–≤–∏—Ç—å CI/CD (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–±–æ—Ä–∫—É –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—é)"
- –ò–∑–±–µ–≥–∞–π –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä –±–µ–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏: –≤–º–µ—Å—Ç–æ "–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å SSR" –ø–∏—à–∏ "–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å SSR (—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è SEO)"
- –í–º–µ—Å—Ç–æ "–∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å" –ø–∏—à–∏ "–¥–æ–±–∞–≤–∏—Ç—å/–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å"
- –í–º–µ—Å—Ç–æ "–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å API" –ø–∏—à–∏ "–ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å X"
- –í –æ–ø–∏—Å–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –¥–∞–≤–∞–π –ø–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –ø–æ–π–º—ë—Ç –Ω–æ–≤–∏—á–æ–∫
- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫:
  - "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (CI) ‚Äî —á—Ç–æ–±—ã –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π"
  - "–î–æ–±–∞–≤–∏—Ç—å Redis (–±—ã—Å—Ç—Ä–∞—è –±–∞–∑–∞ –¥–ª—è –∫—ç—à–∞) ‚Äî —É—Å–∫–æ—Ä–∏—Ç –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü"
  - "–ü–æ–¥–∫–ª—é—á–∏—Ç—å Stripe (—Å–µ—Ä–≤–∏—Å –æ–ø–ª–∞—Ç—ã) ‚Äî —á—Ç–æ–±—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∫–∞—Ä—Ç—ã"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

–¢–≤–æ–π –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù –∏–º–µ—Ç—å –¢–û–ß–ù–û —Ç–∞–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (—è —É–∂–µ –Ω–∞–ø–∏—Å–∞–ª { –∑–∞ —Ç–µ–±—è, –ø—Ä–æ–¥–æ–ª–∂–∞–π):

"needs_clarification": false,
"questions": [],
"analysis": {
  "project_summary": "...",
  "detected_stage": "mvp",
  "tech_stack": ["..."],
  "strengths": [...],
  "issues": [...],
  "tasks": [...],
  "next_milestone": "..."
}
}

–í–ê–ñ–ù–û: –í–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞! –ü–æ–ª—è strengths, issues, tasks –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –í–ù–£–¢–†–ò –æ–±—ä–µ–∫—Ç–∞ "analysis", –Ω–µ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ!

–ü—Ä–æ–¥–æ–ª–∂–∞–π JSON —Å "needs_clarification":`;
}

// ===========================================
// Chat Prompt
// ===========================================

export function buildChatPrompt(
  message: string,
  previousAnalysis: object,
  files?: FileInput[]
): string {
  const filesContext = files
    ? `\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:\n${files.map(f => `- ${f.path}`).join('\n')}`
    : '';

  return `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —Å—Ç–∞—Ä—Ç–∞–ø–∞–º. –£ —Ç–µ–±—è –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–µ–∫—Ç–∞.

## –ü—Ä–µ–¥—ã–¥—É—â–∏–π –∞–Ω–∞–ª–∏–∑
${JSON.stringify(previousAnalysis, null, 2)}
${filesContext}

## –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
${message}

---

–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —É—á–∏—Ç—ã–≤–∞—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞.

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É ‚Äî –¥–∞–π –ø–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é.
–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–ø–æ—á–µ–º—É" ‚Äî –æ–±—ä—è—Å–Ω–∏ reasoning.
–ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã.

–û—Ç–≤–µ—á–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏ –ø–æ –¥–µ–ª—É. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ ‚Äî –¥–∞–≤–∞–π –∏—Ö.`;
}

// ===========================================
// Full Analysis Chat Prompt
// ===========================================

interface FullAnalysisContext {
  codeAnalysis?: {
    project_summary: string;
    detected_stage: string;
    tech_stack: string[];
    strengths: Array<{ area: string; detail: string }>;
    issues: Array<{ severity: string; area: string; detail: string; file_path?: string }>;
    tasks: Array<{ title: string; description: string; priority: string; category: string }>;
    next_milestone: string;
  };
  businessCanvas?: {
    value_proposition: string;
    customer_segments: string[];
    channels: string[];
    revenue_streams: string[];
    key_resources: string[];
    key_activities: string[];
    key_partners: string[];
    customer_relationships?: string;
    cost_structure: string[];
  };
  gapAnalysis?: {
    gaps?: Array<{
      category: string;
      type: string;
      current_state: string;
      recommendation: string;
      impact?: string;
    }>;
    alignment_score?: number;
    verdict?: string;
    tasks?: Array<{ title: string; description: string; priority: string; category: string }>;
  };
  competitorAnalysis?: {
    your_advantages?: string[];
    your_gaps?: string[];
    market_position?: string;
    recommendations?: string[];
  };
}

export function buildFullAnalysisChatPrompt(
  message: string,
  context: FullAnalysisContext
): string {
  const sections: string[] = [];

  // Business Canvas section
  if (context.businessCanvas) {
    const canvas = context.businessCanvas;
    sections.push(`## –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å (Business Canvas)

**–¶–µ–Ω–Ω–æ—Å—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:** ${canvas.value_proposition}
**–°–µ–≥–º–µ–Ω—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤:** ${canvas.customer_segments.join(', ')}
**–ö–∞–Ω–∞–ª—ã:** ${canvas.channels.join(', ')}
**–ü–æ—Ç–æ–∫–∏ –¥–æ—Ö–æ–¥–∞:** ${canvas.revenue_streams.join(', ')}
**–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã:** ${canvas.key_resources.join(', ')}
**–ö–ª—é—á–µ–≤—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:** ${canvas.key_activities.join(', ')}
**–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä—ã:** ${canvas.key_partners.join(', ')}
${canvas.customer_relationships ? `**–û—Ç–Ω–æ—à–µ–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏:** ${canvas.customer_relationships}` : ''}
**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç:** ${canvas.cost_structure.join(', ')}`);
  }

  // Code Analysis section
  if (context.codeAnalysis) {
    const code = context.codeAnalysis;
    sections.push(`## –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

**–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:** ${code.project_summary}
**–°—Ç–∞–¥–∏—è:** ${code.detected_stage}
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** ${code.tech_stack.join(', ')}
**–°–ª–µ–¥—É—é—â–∞—è —Ü–µ–ª—å:** ${code.next_milestone}

### –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:
${code.strengths.map(s => `- **${s.area}:** ${s.detail}`).join('\n')}

### –ü—Ä–æ–±–ª–µ–º—ã:
${code.issues.map(i => `- [${i.severity.toUpperCase()}] **${i.area}:** ${i.detail}${i.file_path ? ` (—Ñ–∞–π–ª: ${i.file_path})` : ''}`).join('\n')}`);
  }

  // Gap Analysis section
  if (context.gapAnalysis) {
    const gaps = context.gapAnalysis;
    const verdictText = gaps.verdict === 'ON_TRACK' ? '‚úÖ –í—Å—ë —Ö–æ—Ä–æ—à–æ' :
                       gaps.verdict === 'ITERATE' ? 'üîÑ –¢—Ä–µ–±—É—é—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏—è' :
                       gaps.verdict === 'PIVOT' ? '‚ö†Ô∏è –°–µ—Ä—å—ë–∑–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω—É–∂–Ω—ã' : gaps.verdict;

    sections.push(`## –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑—Ä—ã–≤–æ–≤ (Gap Detection)

**Alignment Score:** ${gaps.alignment_score ?? 'N/A'}/100
**–í–µ—Ä–¥–∏–∫—Ç:** ${verdictText}

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–∞–∑—Ä—ã–≤—ã:
${gaps.gaps?.map(g => {
  const severityEmoji = g.type === 'critical' ? 'üî¥' : g.type === 'warning' ? 'üü°' : 'üîµ';
  return `- ${severityEmoji} **${g.category}:** ${g.current_state}
  ‚Üí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ${g.recommendation}`;
}).join('\n') || '–†–∞–∑—Ä—ã–≤–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}`);
  }

  // Competitor Analysis section
  if (context.competitorAnalysis) {
    const comp = context.competitorAnalysis;
    sections.push(`## –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤

**–ü–æ–∑–∏—Ü–∏—è –Ω–∞ —Ä—ã–Ω–∫–µ:** ${comp.market_position || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}

### –í–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
${comp.your_advantages?.map(a => `- ${a}`).join('\n') || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã'}

### –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:
${comp.your_gaps?.map(g => `- ${g}`).join('\n') || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã'}

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
${comp.recommendations?.map(r => `- ${r}`).join('\n') || '–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π'}`);
  }

  // All tasks (from code analysis and gap analysis)
  const allTasks = [
    ...(context.codeAnalysis?.tasks || []),
    ...(context.gapAnalysis?.tasks || [])
  ];

  if (allTasks.length > 0) {
    sections.push(`## –ó–∞–¥–∞—á–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é

${allTasks.map((t, i) => `${i + 1}. **${t.title}** [${t.priority}]
   ${t.description}`).join('\n\n')}`);
  }

  return `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —Å—Ç–∞—Ä—Ç–∞–ø–∞–º –∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º. –£ —Ç–µ–±—è –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–µ–∫—Ç–∞: –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–∞–∑—Ä—ã–≤—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞—Ö.

${sections.join('\n\n---\n\n')}

---

## –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
${message}

---

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–û—Ç–≤–µ—á–∞–π —Å —É—á—ë—Ç–æ–º –ü–û–õ–ù–û–ì–û –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞:
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ –±–∏–∑–Ω–µ—Å–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π Business Canvas
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ –∫–æ–¥–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞—Ö ‚Äî —É—á–∏—Ç—ã–≤–∞–π Gap Detection –∏ Alignment Score
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤

**–ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–≤–µ—Ç–∞:**
1. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º ‚Äî –¥–∞–≤–∞–π actionable —Å–æ–≤–µ—Ç—ã
2. –°–≤—è–∑—ã–≤–∞–π –æ—Ç–≤–µ—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º ‚Äî "—É—á–∏—Ç—ã–≤–∞—è –≤–∞—à Alignment Score 65..."
3. –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏ ‚Äî –¥–∞–≤–∞–π –ø–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
4. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç "–ø–æ—á–µ–º—É" ‚Äî –æ–±—ä—è—Å–Ω—è–π —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –±–∏–∑–Ω–µ—Å-—Ü–µ–ª—è–º
5. –ü—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏.`;
}
